{"guide": {"name": "resource-cleanup", "category": "additional-features", "pretty_category": "Additional Features", "guide_index": 9, "absolute_index": 22, "pretty_name": "Resource Cleanup", "content": "# Resource Cleanup\n\nYour Gradio application may create resources during its lifetime.\nExamples of resources are `gr.State` variables, any variables you create and explicitly hold in memory, or files you save to disk. \nOver time, these resources can use up all of your server's RAM or disk space and crash your application.\n\nGradio provides some tools for you to clean up the resources created by your app:\n\n1. Automatic deletion of `gr.State` variables.\n2. Automatic cache cleanup with the `delete_cache` parameter.\n2. The `Blocks.unload` event.\n\nLet's take a look at each of them individually.\n\n## Automatic deletion of `gr.State`\n\nWhen a user closes their browser tab, Gradio will automatically delete any `gr.State` variables associated with that user session after 60 minutes. If the user connects again within those 60 minutes, no state will be deleted.\n\nYou can control the deletion behavior further with the following two parameters of `gr.State`:\n\n1. `delete_callback` - An arbitrary function that will be called when the variable is deleted. This function must take the state value as input. This function is useful for deleting variables from GPU memory.\n2. `time_to_live` - The number of seconds the state should be stored for after it is created or updated. This will delete variables before the session is closed, so it's useful for clearing state for potentially long running sessions.\n\n## Automatic cache cleanup via `delete_cache`\n\nYour Gradio application will save uploaded and generated files to a special directory called the cache directory. Gradio uses a hashing scheme to ensure that duplicate files are not saved to the cache but over time the size of the cache will grow (especially if your app goes viral \ud83d\ude09).\n\nGradio can periodically clean up the cache for you if you specify the `delete_cache` parameter of `gr.Blocks()`, `gr.Interface()`, or `gr.ChatInterface()`. \nThis parameter is a tuple of the form `[frequency, age]` both expressed in number of seconds.\nEvery `frequency` seconds, the temporary files created by this Blocks instance will be deleted if more than `age` seconds have passed since the file was created. \nFor example, setting this to (86400, 86400) will delete temporary files every day if they are older than a day old.\nAdditionally, the cache will be deleted entirely when the server restarts.\n\n## The `unload` event\n\nAdditionally, Gradio now includes a `Blocks.unload()` event, allowing you to run arbitrary cleanup functions when users disconnect (this does not have a 60 minute delay).\nUnlike other gradio events, this event does not accept inputs or outptus.\nYou can think of the `unload` event as the opposite of the `load` event.\n\n## Putting it all together\n\nThe following demo uses all of these features. When a user visits the page, a special unique directory is created for that user.\nAs the user interacts with the app, images are saved to disk in that special directory.\nWhen the user closes the page, the images created in that session are deleted via the `unload` event.\nThe state and files in the cache are cleaned up automatically as well.\n\n```python\nfrom __future__ import annotations\nimport gradio as gr\nimport numpy as np\nfrom PIL import Image\nfrom pathlib import Path\nimport secrets\nimport shutil\n\ncurrent_dir = Path(__file__).parent\n\ndef generate_random_img(history: list[Image.Image], request: gr.Request):\n    \"\"\"Generate a random red, green, blue, orange, yellor or purple image.\"\"\"\n    colors = [(255, 0, 0), (0, 255, 0), (0, 0, 255), (255, 165, 0), (255, 255, 0), (128, 0, 128)]\n    color = colors[np.random.randint(0, len(colors))]\n    img = Image.new('RGB', (100, 100), color)\n\n    user_dir: Path = current_dir / str(request.session_hash)\n    user_dir.mkdir(exist_ok=True)\n    path = user_dir / f\"{secrets.token_urlsafe(8)}.webp\"\n\n    img.save(path)\n    history.append(img)\n\n    return img, history, history\n\ndef delete_directory(req: gr.Request):\n    if not req.username:\n        return\n    user_dir: Path = current_dir / req.username\n    shutil.rmtree(str(user_dir))\n\nwith gr.Blocks(delete_cache=(60, 3600)) as demo:\n    gr.Markdown(\"\"\"# State Cleanup Demo\n                \ud83d\uddbc\ufe0f Images are saved in a user-specific directory and deleted when the users closes the page via demo.unload.\n                \"\"\")\n    with gr.Row():\n        with gr.Column(scale=1):\n            with gr.Row():\n                img = gr.Image(label=\"Generated Image\", height=300, width=300)\n            with gr.Row():\n                gen = gr.Button(value=\"Generate\")\n            with gr.Row():\n                history = gr.Gallery(label=\"Previous Generations\", height=500, columns=10)\n                state = gr.State(value=[], delete_callback=lambda v: print(\"STATE DELETED\"))\n\n    demo.load(generate_random_img, [state], [img, state, history])\n    gen.click(generate_random_img, [state], [img, state, history])\n    demo.unload(delete_directory)\n\ndemo.launch()\n\n```\n<gradio-app space='gradio/state_cleanup'></gradio-app>", "tags": [], "spaces": [], "url": "/guides/resource-cleanup/", "contributor": null}}